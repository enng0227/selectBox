(function(e){"use strict";var t={},i=function(){},l=["margin","padding"],n=["Left","Right","Top","Bottom"],o=["float","display","margin","width"],a=["create","change","formatter","filterItem","filter","filtered","input"],s=1,r='<div class="select-box"><div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl></div>',c={dataKey:[],style:{},keys:{text:"text",value:"id"},placeholder:null,options:null,combo:false,clearText:false,hideArrowOnDisabled:false,toggleArrow:false,disabled:false,noBorder:false,maxHeight:null,copyStyle:true,input:null,filter:null,filtered:null,filterItem:null,formatter:null,create:null,change:null},d={init:function(e,t){this.validProp(e);this.create(e,t);this.bindEvent(e);return this.getMethods(e)},validProp:function(t){e.each(a,function(i,l){if(!e.isFunction(t.config[l])){t.config[l]=null}})},change:function(t,i,l){var n=t.config,o=n.keys;if(i&&l){if(t.originSelectSource){var a=n.node,s=a.find('option[value="'+i[o.value]+'"]'),r=a.find('option[value="'+l[o.value]+'"]');if(s.length){s.attr("selected","selected").prop("selected",true)}if(r.length){r.removeAttr("selected").prop("selected",false)}a.trigger("change")}if(n.combo&&n.input){n.input.call(t,this.getSelected(t))}if(n.change){var c=e.extend({},i);delete c.__placeholder;n.change.call(t,c)}}return true},getSelected:function(e){var t=e.config,i=t.options||[],l=t.keys,n=e.text&&e.text.val(),o=e.selected?e.selected.data("select-index"):0,a=i[o];if(t.combo){if(a&&a[l.text]===n){a.custom=false;return a}else{var s={};s[l.text]=n;s[l.value]="";s.selected=true;s.custom=true;return s}}else{return a}},selectOption:function(e,t,i){if(e&&t){var l=t.data("group-index"),n=t.data("select-index"),o=e[l];t.toggleClass("on",i);if(o&&(o.options||o.__placeholder)){var a=o.__placeholder?o:o.options[n];if(a){a.selected=i}return a}}return null},setSelected:function(e,t){if(!t.jquery){t=e.wrap.find('dd[data-id="'+t+'"]')}if(t.length&&!t.hasClass("on")){var i=this,l=e.config,n=l.isGroup?l.options:[{options:l.options}],o=t.text(),a=i.selectOption(n,e.selected,false),s=i.selectOption(n,t,true);if(s){e.selected=t;if(l.formatter){o=l.formatter(o)}e.text.val(o).attr("value",o).toggleClass("placeholder",!!s.__placeholder)}return i.change(e,s,a)}return false},unbindEvent:function(e){var t=e.wrap,i=e.config;if(t){t.toggleClass("hide-arrow",!!i.hideArrowOnDisabled);t.addClass("disabled");t.removeClass("open");t.off("click");if(i.combo&&i.input){t.off("input propertychange")}}},bindEvent:function(i){var l=this,n=i.wrap,o=i.config;l.unbindEvent(i);if(n&&!o.disabled){n.toggleClass("hide-arrow",!!o.hideArrowOnDisabled);n.removeClass("disabled");if(o.combo&&o.input){n.on("input propertychange",".select-text",function(){o.input.call(i,l.getSelected(i))})}n.on("click",".select-box-inner",function(a){if(n.hasClass("open")){n.removeClass("open")}else{if(t.wrap){t.wrap.removeClass("open")}t.wrap=i.wrap;if(o.filterItem){l._setOptions(i)}n.addClass("open");if(o.combo&&o.clearText){var s=e(a.target);if(s.is(".select-text")){s.val("");n.removeClass("open")}}}});n.on("click","dd",function(){l.setSelected(i,e(this));n.removeClass("open")});l._preventScroll(i.listWrap);if(!t.doc){t.doc=e(document).on("click",function(i){var l=e(i.target);if(!l.is(".select-box")&&!l.closest(".select-box").length&&t.wrap){t.wrap.removeClass("open")}})}}if(o.create){o.create.call(i,this.getSelected(i))}},getBoxId:function(e){var t=e.data("select-box-id");if(e&&!t){t="select_"+s++;e.attr("data-select-box-id",t)}return t},create:function(t,i){var l=this,n=t.config,o=n.node,a=n.options=n.options||[];var s=l._parseOptions(t,n,a,i);if(s&&e.type(n.disabled)==="undefined"){n.disabled=o.prop("disabled")||o.attr("disabled")||o.attr("readonly")}t.wrap=l.createWrap(o,t.originSelectSource,n);t.listWrap=t.wrap.find("dl");t.wrap.css(n.style);if(n.maxHeight){t.listWrap.css({maxHeight:n.maxHeight})}t.listWrap.toggleClass("group",n.isGroup);t.text=t.wrap.find(".select-text").attr("readonly",!n.combo);if(n.noBorder){t.wrap.find(".select-box-inner").css({borderColor:"transparent"})}l._setOptions(t,true)},fetch:function(e,t,i){if(e&&e.length&&i){for(var l=0;l<e.length;l++){var n=e[l];if(n&&!t[n]){i(n)}}}},createWrap:function(t,i,a){var s=t;if(i){if(a.copyStyle){var c={},d=e.isArray(a.copyStyle)?a.copyStyle:o;e.each(d,function(i,o){var a=t.css(o);if(a){c[o]=a}else if(e.inArray(o,l)>-1){e.each(n,function(e,i){c[o+i]=t.css(o+i)})}});if(!a.options.length){delete c.width}a.style=e.extend(true,{},c,a.style)}s=t.prev("div.select-box");if(!s.length){s=e(r);t.hide().before(s)}}else{t.addClass("select-box");if(!t.find(".select-box-inner").length||!t.find("dl").length){t.html('<div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl>')}}return s.toggleClass("combo",!!a.combo).toggleClass("toggle",!!a.toggleArrow)},_parseOptions:function(e,t,i,l){var n=this,o=t.node,a=t.keys,s=false,r=false,c=false;if(!l){e.originStyle=o.attr("style");e.originClass=o.attr("class");e.sourceHTML=o.html()}if(i.length){s=!!i[0].label&&!i[0][a.text]&&!i[0][a.value]}else{if(o.is("select")){o.css("visibility","hidden");var d=o.find("optgroup");s=!!d.length;if(!s){d=d.add(o)}d.each(function(e){var l=d.eq(e),r=s?[]:i,c=l.find("option");c.each(function(e){var i={},l=c.eq(e);i[a.text]=l.text();i[a.value]=l.attr("value")||"";i.selected=l.prop("selected");n.fetch(t.dataKey,a,function(e){i[e]=l.data(e)||o.data(e)});if(!t.placeholder||i[a.value]&&i[a.text]){r.push(i)}});if(s){i.push({label:l.attr("label"),options:r})}});c=true}else{var f=o.find("dl");s=f.length>1;if(f.length){f.each(function(e){var l=f.eq(e),r=s?[]:i,c=l.find("dd");c.each(function(e){var i={},l=c.eq(e);i[a.text]=l.text();i[a.value]=l.data(a.value)||"";i.selected=!!l.data("selected");n.fetch(t.dataKey,a,function(e){i[e]=l.data(e)||o.data(e)});if(!t.placeholder||i[a.value]&&i[a.text]){r.push(i)}});if(s){i.push({label:l.data("label"),options:r})}});r=true}}}e.originSelectSource=c;e.ddSource=r;t.isGroup=s;return c||r},_setPlaceholder:function(e,t,i){if(e.placeholder){var l=e.keys,n={};if(t.length&&t[0].placeholder){t.shift()}if(!i&&(!t.length||t[0][l.text]!==e.placeholder)){n[l.text]=e.placeholder;n[l.value]="";n.selected=false;n.__placeholder=true;t.splice(0,0,n)}}},_showSelected:function(e){var t=e.config,i=e.wrap.find("dd.on"),l=t.options||[];if(!i.length){i=e.wrap.find("dd:eq(0)").addClass("on")}var n=l[e.selected?e.selected.data("select-index"):0],o=i.text();if(t.formatter){o=t.formatter(o)}e.selected=i;e.text.val(o).attr("value",o).toggleClass("placeholder",!!n.__placeholder)},_setOptions:function(e,t,i){var l=e.config,n=l.options,o=false,a=l.keys;if(t&&l.filter){n=l.options=l.filter(n)}this._setPlaceholder(l,n,i);for(var s=0;s<n.length;s++){if(n[s].selected){o=true;break}}if(!o&&n[0]){n[0].selected=true}var r=this._getOptionsHtml(l.isGroup,n,a,l.filterItem);e.listWrap.html(r);this._showSelected(e);if(l.filtered){l.filtered.call(e,n)}if(e.wrap.css("visibility")!=="visible"){e.wrap.css("visibility","visible")}},_getOptionHtml:function(e,t,i,l){return'<dd data-group-index="'+(l||0)+'" data-select-index="'+i+'" data-id="'+e[t.value]+'"'+(e.selected?' class="on"':"")+">"+e[t.text]+"</dd>"},_getOptionsHtml:function(e,t,i,l){var n=[];if(t&&t.length){var o=e?t:[{options:t}];for(var a=0;a<o.length;a++){var s=o[a];if(s.__placeholder){n.push(this._getOptionHtml(s,i,0,0));continue}if(e){n.push("<dt>"+(s.label||a+1)+"</dt>")}var r=s.options;if(l){for(var c=0;c<r.length;c++){var d=r[c];d.is_valid=l(d);if(d.is_valid){n.push(this._getOptionHtml(d,i,c,a))}}}else{for(var f=0;f<r.length;f++){n.push(this._getOptionHtml(r[f],i,f,a))}}}}return n.join("")},_preventScroll:function(t){var i=t.jquery?t:e(t);t=i.get(0);if(!i.data("mouse-wheel")){i.attr("data-mouse-wheel",1);if(navigator.userAgent.indexOf("Firefox")>=0){t.addEventListener("DOMMouseScroll",function(e){t.scrollTop+=e.detail>0?60:-60;e.preventDefault()},false)}else{t.onmousewheel=function(e){e=e||window.event;t.scrollTop+=e.wheelDelta>0?-60:60;return false}}}},setOptions:function(e,t,i,l){var n=e.config;e.originSelectSource=false;if(t){delete n.options;n.options=t}delete e.selected;this._setOptions(e,i,l)},getMethods:function(i){var l=this,n=i.config,o={};o.setConfig=function(t){e.extend(true,i.config,t);o.refresh()};o.val=function(e){if(e){return l.setSelected(i,e)}else{return l.getSelected(i)}};o.setOptions=function(e,t,n){l.setOptions(i,e,t,n)};o.refresh=function(){var e=n.options;for(var t=0;t<e.length;t++){if(e[t].selected){e[t].selected=false}}delete i.selected;if(i.originSelectSource){delete n.options}l.init(i,true)};o.disable=function(){if(!n.disabled){n.disabled=true;l.unbindEvent(i);if(n.combo){i.text.attr("readonly","readonly")}}};o.enable=function(){if(n.disabled){n.disabled=false;l.bindEvent(i);if(n.combo){i.text.removeAttr("readonly")}}};o.destroy=function(){l.unbindEvent(i);var e=i.config,n=e.node,o=l.getBoxId(n);if(i.originSelectSource){i.wrap.next().css("visibility","visible").show();i.wrap.remove()}else{i.wrap.html(i.sourceHTML)}n.attr({"data-select-box-id":null,style:i.originStyle||null,"class":i.originClass||null});delete t[o]};return o}};var f=function(t,i){this.config=e.extend(true,{node:e(t)},c,i);return d.init(this)};e.fn.extend({selectBox:function(e){var i=this.first(),l=d.getBoxId(i);if(t[l]){t[l].setConfig(e)}else{t[l]=new f(i,e)}return t[l]},selectBoxs:function(){var t=Array.prototype.slice.apply(arguments),l=t.shift();if(e.type(l)==="string"){var n=e.type(t[t.length-1])==="function"?t.pop():i;return this.each(function(){var i=e(this).selectBox();if(i&&i[l]){n.call(i,i[l].apply(this,t))}})}return this.each(function(){e(this).selectBox(e.extend(true,{},l))})}})})(jQuery);