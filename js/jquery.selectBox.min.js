(function(e){"use strict";var t={},i=function(){},l=["margin","padding"],n=["Left","Right","Top","Bottom"],o=["float","display","margin","width"],s=["create","change","formatter","filterItem","filter","filtered","input"],a=1,r='<div class="select-box"><div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl></div>',c={dataKey:[],style:{},keys:{text:"text",value:"id"},placeholder:null,options:null,combo:false,clearText:false,hideArrowOnDisabled:false,toggleArrow:false,disabled:false,noBorder:false,maxHeight:null,copyStyle:true,input:null,filter:null,filtered:null,filterItem:null,formatter:null,create:null,change:null},d={init:function(e,t){this.validProp(e);this.create(e,t);this.bindEvent(e);return this.getMethods(e)},validProp:function(t){e.each(s,function(i,l){if(!e.isFunction(t.config[l])){t.config[l]=null}})},change:function(t,i,l){var n=t.config,o=n.keys;if(i&&l){if(t.originSelectSource){var s=n.node,a=s.find('option[value="'+i[o.value]+'"]'),r=s.find('option[value="'+l[o.value]+'"]');if(a.length){a.attr("selected","selected").prop("selected",true)}if(r.length){r.removeAttr("selected").prop("selected",false)}s.trigger("change")}if(n.combo&&n.input){n.input.call(t,this.getSelected(t))}if(n.change){var c=e.extend({},i);delete c.__placeholder;n.change.call(t,c)}}return true},getSelected:function(e){var t=e.config,i=t.options||[],l=t.keys,n=e.text&&e.text.val(),o=e.selected?e.selected.data("select-index"):0,s=i[o];if(t.combo){if(s&&s[l.text]===n){s.custom=false;return s}else{var a={};a[l.text]=n;a[l.value]="";a.selected=true;a.custom=true;return a}}else{return s}},selectOption:function(e,t,i){if(e&&t){var l=t.data("group-index"),n=t.data("select-index"),o=e[l];t.toggleClass("on",i);if(o&&(o.options||o.__placeholder)){var s=o.__placeholder?o:o.options[n];if(s){s.selected=i}return s}}return null},setSelected:function(t,i){var l=e.type(i)==="undefined";if(l){i=t.wrap.find("dd.on");if(!i.length){i=t.wrap.find("dd").first()}}if(!i.jquery){i=t.wrap.find('dd[data-id="'+i+'"]')}if(l||i.length&&!i.hasClass("on")){var n=t.config,o=n.isGroup?n.options:[{options:n.options}],s=i.text(),a=this.selectOption(o,t.selected,false),r=this.selectOption(o,i,true);if(r){t.selected=i;if(n.formatter){s=n.formatter(s)}t.text.val(s).attr("value",s).toggleClass("placeholder",!!r.__placeholder)}return!l&&this.change(t,r,a)}return false},unbindEvent:function(e){var t=e.wrap,i=e.config;if(t){t.toggleClass("hide-arrow",!!i.hideArrowOnDisabled);t.addClass("disabled");t.removeClass("open");t.off("click");if(i.combo&&i.input){t.off("input propertychange")}}},bindEvent:function(i){var l=this,n=i.wrap,o=i.config;l.unbindEvent(i);if(n&&!o.disabled){n.toggleClass("hide-arrow",!!o.hideArrowOnDisabled);n.removeClass("disabled");if(o.combo&&o.input){n.on("input propertychange",".select-text",function(){o.input.call(i,l.getSelected(i))})}n.on("click",".select-box-inner",function(s){if(n.hasClass("open")){n.removeClass("open")}else{if(t.wrap){t.wrap.removeClass("open")}t.wrap=i.wrap;if(o.filterItem){l._setOptions(i)}n.addClass("open");if(o.combo&&o.clearText){var a=e(s.target);if(a.is(".select-text")){a.val("");n.removeClass("open")}}}});n.on("click","dd",function(){l.setSelected(i,e(this));n.removeClass("open")});l._preventScroll(i.listWrap);if(!t.doc){t.doc=e(document).on("click",function(i){var l=e(i.target);if(!l.is(".select-box")&&!l.closest(".select-box").length&&t.wrap){t.wrap.removeClass("open")}})}}if(o.create){o.create.call(i,this.getSelected(i))}},getBoxId:function(e){var t=e.data("select-box-id");if(e&&!t){t="select_"+a++;e.attr("data-select-box-id",t)}return t},create:function(t,i){var l=t.config,n=l.node,o=l.options=l.options||[];var s=this._parseOptions(t,l,o,i);if(s&&e.type(l.disabled)==="undefined"){l.disabled=n.prop("disabled")||n.attr("disabled")||n.attr("readonly")}t.wrap=this.createWrap(n,t.originSelectSource,l);t.listWrap=t.wrap.find("dl");t.wrap.css(l.style);if(l.maxHeight){t.listWrap.css({maxHeight:l.maxHeight})}t.listWrap.toggleClass("group",l.isGroup);t.text=t.wrap.find(".select-text").attr("readonly",!l.combo);if(l.noBorder){t.wrap.find(".select-box-inner").css({borderColor:"transparent"})}this._setOptions(t,true);this.setSelected(t)},fetch:function(e,t,i){if(e&&e.length&&i){for(var l=0;l<e.length;l++){var n=e[l];if(n&&!t[n]){i(n)}}}},createWrap:function(t,i,s){var a=t;if(i||t.is("select")){if(s.copyStyle){var c={},d=e.isArray(s.copyStyle)?s.copyStyle:o;e.each(d,function(i,o){var s=t.css(o);if(s){c[o]=s}else if(e.inArray(o,l)>-1){e.each(n,function(e,i){c[o+i]=t.css(o+i)})}});if(!s.options.length){delete c.width}s.style=e.extend(true,{},c,s.style)}a=t.prev("div.select-box");if(!a.length){a=e(r);t.hide().before(a)}}else{t.addClass("select-box");if(!t.find(".select-box-inner").length||!t.find("dl").length){t.html('<div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl>')}}return a.toggleClass("combo",!!s.combo).toggleClass("toggle",!!s.toggleArrow)},_parseOptions:function(e,t,i,l){var n=this,o=t.node,s=t.keys,a=false,r=false,c=false;if(i.length){a=!!i[0].label&&!i[0][s.text]&&!i[0][s.value]}else{if(!l){e.originStyle=o.attr("style");e.originClass=o.attr("class");e.sourceHTML=o.html()}if(o.is("select")){o.css("visibility","hidden");var d=o.find("optgroup");a=!!d.length;if(!a){d=d.add(o)}d.each(function(e){var l=d.eq(e),r=a?[]:i,c=l.find("option");c.each(function(e){var i={},l=c.eq(e);i[s.text]=l.text();i[s.value]=l.attr("value")||"";i.selected=e&&l.prop("selected");n.fetch(t.dataKey,s,function(e){i[e]=l.data(e)||o.data(e)});if(!t.placeholder||i[s.value]&&i[s.text]){r.push(i)}});if(a){i.push({label:l.attr("label"),options:r})}});c=true}else{var f=o.find("dl");a=f.length>1;if(f.length){f.each(function(e){var l=f.eq(e),r=a?[]:i,c=l.find("dd");c.each(function(e){var i={},l=c.eq(e);i[s.text]=l.text();i[s.value]=l.data(s.value)||"";i.selected=e&&!!l.data("selected");n.fetch(t.dataKey,s,function(e){i[e]=l.data(e)||o.data(e)});if(!t.placeholder||i[s.value]&&i[s.text]){r.push(i)}});if(a){i.push({label:l.data("label"),options:r})}});r=true}}}e.originSelectSource=c;e.ddSource=r;t.isGroup=a;return c||r},_setPlaceholder:function(e,t,i){if(e.placeholder){var l=e.keys,n={};if(t.length&&t[0].placeholder){t.shift()}if(!i&&(!t.length||t[0][l.text]!==e.placeholder)){n[l.text]=e.placeholder;n[l.value]="";n.selected=false;n.__placeholder=true;t.splice(0,0,n)}}},_setOptions:function(e,t,i){var l=e.config,n=l.options,o=l.keys;if(t&&l.filter){n=l.options=l.filter(n)}this._setPlaceholder(l,n,i);var s=this._getOptionsHtml(l.isGroup,n,o,l.filterItem);e.listWrap.html(s);if(l.filtered){l.filtered.call(e,n)}if(e.wrap.css("visibility")!=="visible"){e.wrap.css("visibility","visible")}},_getOptionHtml:function(e,t,i,l){return"<dd"+(e.__placeholder?" data-placeholder":"")+' data-group-index="'+(l||0)+'" data-select-index="'+i+'" data-id="'+e[t.value]+'"'+(e.selected?' class="on"':"")+">"+e[t.text]+"</dd>"},_getOptionsHtml:function(e,t,i,l){var n=[];if(t&&t.length){var o=e?t:[{options:t}];for(var s=0;s<o.length;s++){var a=o[s];if(a.__placeholder){n.push(this._getOptionHtml(a,i,0,0));continue}if(e){n.push("<dt>"+(a.label||s+1)+"</dt>")}var r=a.options;if(l){for(var c=0;c<r.length;c++){var d=r[c];d.is_valid=l(d);if(d.is_valid){n.push(this._getOptionHtml(d,i,c,s))}}}else{for(var f=0;f<r.length;f++){n.push(this._getOptionHtml(r[f],i,f,s))}}}}return n.join("")},_preventScroll:function(t){var i=t.jquery?t:e(t);t=i.get(0);if(!i.data("mouse-wheel")){i.attr("data-mouse-wheel",1);if(navigator.userAgent.indexOf("Firefox")>=0){t.addEventListener("DOMMouseScroll",function(e){t.scrollTop+=e.detail>0?60:-60;e.preventDefault()},false)}else{t.onmousewheel=function(e){e=e||window.event;t.scrollTop+=e.wheelDelta>0?-60:60;return false}}}},setOptions:function(e,t,i,l){var n=e.config;e.originSelectSource=false;if(t){delete n.options;n.options=t}delete e.selected;this._setOptions(e,i,l)},getMethods:function(i){var l=this,n=i.config,o={};o.setConfig=function(t){e.extend(true,i.config,t);o.refresh()};o.val=function(e){if(e){return l.setSelected(i,e)}else{return l.getSelected(i)}};o.setOptions=function(e,t,n){l.setOptions(i,e,t,n)};o.refresh=function(){var e=n.options;for(var t=0;t<e.length;t++){if(e[t].selected){e[t].selected=false}}delete i.selected;if(i.originSelectSource){delete n.options}l.init(i,true)};o.disable=function(){if(!n.disabled){n.disabled=true;l.unbindEvent(i);if(n.combo){i.text.attr("readonly","readonly")}}};o.enable=function(){if(n.disabled){n.disabled=false;l.bindEvent(i);if(n.combo){i.text.removeAttr("readonly")}}};o.destroy=function(){l.unbindEvent(i);var e=i.config,n=e.node,o=l.getBoxId(n);if(i.originSelectSource){i.wrap.next().css("visibility","visible").show();i.wrap.remove()}else{i.wrap.html(i.sourceHTML)}n.attr({"data-select-box-id":null,style:i.originStyle||null,"class":i.originClass||null});delete t[o]};return o}};var f=function(t,i){this.config=e.extend(true,{node:e(t)},c,i);return d.init(this)};e.fn.extend({selectBox:function(e){var i=this.first(),l=d.getBoxId(i);if(t[l]){t[l].setConfig(e)}else{t[l]=new f(i,e)}return t[l]},selectBoxs:function(){var t=Array.prototype.slice.apply(arguments),l=t.shift();if(e.type(l)==="string"){var n=e.type(t[t.length-1])==="function"?t.pop():i;return this.each(function(){var i=e(this).selectBox();if(i&&i[l]){n.call(i,i[l].apply(this,t))}})}return this.each(function(){e(this).selectBox(e.extend(true,{},l))})}})})(jQuery);