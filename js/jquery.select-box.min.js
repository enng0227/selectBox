(function(e){"use strict";var t={},i=1,n='<div class="select-box"><div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl></div>',l={dataKey:[],style:{},keys:{text:"text",value:"id"},placeholder:null,options:null,combo:false,clearTextOnFocus:false,hideArrowOnDisabled:false,toggleArrowOnOpened:false,onInput:null,filter:null,filtered:null,filterItem:null,formatter:null,create:null,change:null,disabled:false,noBorder:false,maxHeight:null,autoCopyStyle:true},s={init:function(e){var t=this,i=e.config,n=i.create;t.create(e);t.unbindEvent(e);if(!i.disabled){t.bindEvent(e)}if(n&&typeof n==="function"){n.call(e,t.getSelected(e))}return t.getMethods(e)},change:function(e,t,i){var n=e.config,l=n.keys;if(e.originSelectSource){var s=n.node,a=s.find('option[value="'+t[l.value]+'"]'),o=s.find('option[value="'+i[l.value]+'"]');if(a.length){a.attr("selected","selected").prop("selected",true)}if(o.length){o.removeAttr("selected").prop("selected",false)}s.trigger("change")}if(n.combo&&n.onInput){n.onInput.call(e,this.getSelected(e))}if(typeof n.change==="function"){n.change.call(e,t)}},getSelected:function(e){var t=e.config,i=t.options||[],n=t.keys,l=e.text&&e.text.val(),s=e.selected?e.selected.data("select-index"):0,a=i[s];if(t.combo){if(a&&a[n.text]===l){a.custom=false;return a}else{var o={};o[n.text]=l;o[n.value]="";o.selected=true;o.custom=true;return o}}else{return a}},setSelected:function(e,t){if(!t.jquery){t=e.wrap.find('dd[data-id="'+t+'"]')}if(!t.length){return false}var i=this,n=e.config,l=n.options,s=t.text(),a=t.data("select-index"),o=l[a],r=null;t.addClass("on");if(e.selected){e.selected.removeClass("on");r=l[e.selected.data("select-index")];if(r){r.selected=false}}o.selected=true;e.selected=t;if(n.formatter){s=n.formatter(s)}e.text.val(s).attr("value",s);i.change(e,o,r);return true},unbindEvent:function(e){var t=e.wrap,i=e.config;if(t){if(i.hideArrowOnDisabled){t.addClass("hide-arrow")}t.addClass("disabled");t.off("click")}},bindEvent:function(i){var n=this,l=i.wrap,s=i.config;if(l){l.removeClass("disabled");if(s.hideArrowOnDisabled){l.removeClass("hide-arrow")}if(s.combo&&s.onInput){l.on("input propertychange",".select-text",function(){s.onInput.call(i,n.getSelected(i))})}l.on("click",".select-box-inner",function(a){if(l.hasClass("open")){l.removeClass("open")}else{if(t.wrap){t.wrap.removeClass("open")}t.wrap=i.wrap;if(s.filterItem){n._setOptions(i)}l.addClass("open");if(s.combo&&s.clearTextOnFocus){var o=e(a.target);if(o.is(".select-text")){o.val("");l.removeClass("open")}}}});l.on("click","dd",function(){var t=e(this);if(!t.hasClass("on")){n.setSelected(i,t)}l.removeClass("open")});n._preventScroll(i.listWrap);if(!t.selectEventProxy){t.selectEventProxy=true;e(document).on("click",function(t){var i=e(t.target);if(!i.is(".select-box")&&!i.closest(".select-box").length){e(".select-box").removeClass("open")}})}}},getBoxId:function(e){var t=e.data("select-box-id");if(e&&!t){t="select_"+i++;e.attr("data-select-box-id",t);return t}return t},create:function(e){var t=this,i=e.config,n=i.node,l=i.options=i.options||[];var s=t._parseOptions(e,i,l);if(s&&typeof i.disabled==="undefined"){i.disabled=n.prop("disabled")||n.attr("disabled")||n.attr("readonly")}e.wrap=t.createWrap(n,s||!n.is("div"),i);e.listWrap=e.wrap.find("dl");e.wrap.css(i.style);if(i.maxHeight){e.listWrap.css({maxHeight:i.maxHeight})}e.text=e.wrap.find(".select-text");e.text.attr("readonly",!i.combo);if(i.noBorder){e.wrap.find(".select-box-inner").css({borderColor:"transparent"})}t._setOptions(e,true)},fetch:function(e,t,i){if(e&&e.length&&i){for(var n=0;n<e.length;n++){var l=e[n];if(l&&!t[l]){i(l)}}}},createWrap:function(t,i,l){var s=t;if(i){s=t.prev("div.select-box");if(!s.length){if(l.autoCopyStyle){var a={width:t.css("width"),marginLeft:t.css("marginLeft"),marginRight:t.css("marginRight"),marginTop:t.css("marginTop"),marginBottom:t.css("marginBottom"),display:t.css("display"),"float":t.css("float")};l.style=e.extend(true,{},a,l.style)}s=e(n);t.before(s);t.hide()}}else{if(!t.hasClass("select-box")){t.addClass("select-box")}if(!t.find(".select-box-inner").length||!t.find("dl").length){t.html('<div class="select-box-inner"><div class="v-align"><input type="text" class="select-text" /></div></div><dl></dl>')}}if(l.combo){s.addClass("combo")}if(l.toggleArrowOnOpened){s.addClass("toggle")}return s},_parseOptions:function(e,t,i){var n=this,l=t.node,s=t.keys,a=false,o=false,r=false;if(!i.length){if(l.is("select")){l.css("visibility","hidden");var d=l.find("option");d.each(function(e){var a={},o=d.eq(e);a[s.text]=o.text();a[s.value]=o.attr("value")||"";a.selected=o.prop("selected");n.fetch(t.dataKey,s,function(e){a[e]=o.data(e)||l.data(e)});i.push(a)});r=true;a=true}else{var c=l.find("dl>dd");if(c.length){c.each(function(e){var a={},o=c.eq(e);a[s.text]=o.text();a[s.value]=o.data(s.value)||"";a.selected=!!o.data("selected");n.fetch(t.dataKey,s,function(e){a[e]=o.data(e)||l.data(e)});i.push(a)});o=true}}}e.originSelectSource=r;e.domSource=o||r;return a},_setPlaceholder:function(e,t,i){if(e.placeholder){var n=e.keys,l={};if(t[0].placeholder){t.shift()}if(!i&&t.length&&t[0][n.text]!==e.placeholder){l[n.text]=e.placeholder;l[n.value]="";l.selected=false;l.placeholder=true;t.splice(0,0,l)}}},_showSelected:function(e){var t=e.config,i=e.wrap.find("dd.on");if(!i.length){i=e.wrap.find("dd:eq(0)").addClass("on")}var n=i.text();if(t.formatter){n=t.formatter(n)}e.selected=i;e.text.val(n).attr("value",n)},_setOptions:function(e,t,i){var n=e.config,l=n.options,s=false,a=n.keys;if(t&&n.filter&&typeof n.filter==="function"){l=n.options=n.filter(l)}this._setPlaceholder(n,l,i);for(var o=0;o<l.length;o++){if(l[o].selected){s=true;break}}if(!s&&l[0]){l[0].selected=true}var r=this._getOptionsHtml(l,a,n.filterItem);e.listWrap.html(r);this._showSelected(e);if(n.filtered){n.filtered.call(e,l)}},_getOptionHtml:function(e,t,i){return'<dd data-select-index="'+i+'" data-id="'+e[t.value]+'"'+(e.selected?' class="on"':"")+">"+e[t.text]+"</dd>"},_getOptionsHtml:function(e,t,i){var n=[];if(e&&e.length){if(i){for(var l=0;l<e.length;l++){var s=e[l];s.is_valid=i(s);if(s.is_valid){n.push(this._getOptionHtml(s,t,l))}}}else{for(var a=0;a<e.length;a++){n.push(this._getOptionHtml(e[a],t,a))}}}return n.join("")},_preventScroll:function(e){if(e.jquery){e=e.get(0)}if(!e.getAttribute("data-mouse-wheel")){e.setAttribute("data-mouse-wheel","bind");if(navigator.userAgent.indexOf("Firefox")>=0){e.addEventListener("DOMMouseScroll",function(t){e.scrollTop+=t.detail>0?60:-60;t.preventDefault()},false)}else{e.onmousewheel=function(t){t=t||window.event;e.scrollTop+=t.wheelDelta>0?-60:60;return false}}}},setOptions:function(e,t,i,n){var l=e.config;e.originSelectSource=false;if(t){delete l.options;l.options=t}delete e.selected;this._setOptions(e,i,n)},getMethods:function(i){var n=this,l=i.config,s={};s.setConfig=function(t){e.extend(true,i.config,t);s.refresh()};s.val=function(e){if(e){return n.setSelected(i,e)}else{return n.getSelected(i)}};s.setOptions=function(e,t,l){n.setOptions(i,e,t,l)};s.refresh=function(){var e=l.options;for(var t=0;t<e.length;t++){if(e[t].selected){e[t].selected=false}}delete i.selected;if(i.originSelectSource){delete l.options}n.init(i)};s.disable=function(){if(!l.disabled){l.disabled=true;n.unbindEvent(i);if(l.combo){i.text.attr("readonly","readonly")}}};s.enable=function(){if(l.disabled){l.disabled=false;n.bindEvent(i);if(l.hideArrowOnDisabled){i.wrap.removeClass("hide-arrow")}if(l.combo){i.text.removeAttr("readonly")}}};s.destroy=function(){n.unbindEvent(i);var e=n.getBoxId(i.config.node);if(i.originSelectSource){i.wrap.next().css("visibility","visible").show();i.wrap.remove()}delete t[e]};return s}};var a=function(t,i){this.config=e.extend(true,{node:e(t)},l,i);return s.init(this)};e.fn.extend({selectBox:function(e){var i=this.eq(0),n=s.getBoxId(i);if(t[n]){t[n].setConfig(e)}else{t[n]=new a(i,e)}return t[n]},selectBoxs:function(){var t=Array.prototype.slice.apply(arguments),i=t.shift();if(e.type(i)==="string"){var n=e.type(t[t.length-1])==="function"?t.pop():function(){};return this.each(function(){var l=e(this).selectBox();if(l&&l[i]){n.call(l,l[i].apply(this,t))}})}return this.each(function(){e(this).selectBox(e.extend(true,{},i))})}})})(jQuery);